### 1. **依赖存储方式**

- npm：
  - 使用扁平化的 node_modules 结构（自 npm 3 起），所有依赖都安装在同一层级，可能会导致大量重复文件。
  - 每个项目都有独立的 node_modules，即使多个项目依赖相同的包，也会重复下载和存储。
- pnpm：
  - 使用**内容寻址存储**（Content-Addressable Storage），全局存储所有依赖的单一副本，项目通过**硬链接**引用这些依赖。
  - 节省磁盘空间，安装速度更快，特别适合多项目开发环境。

### 2. **性能**

- npm：
  - 安装速度较慢，尤其在大型项目中，因为需要重复下载和解压依赖。
  - 每次安装都会创建完整的 node_modules 目录。
- pnpm：
  - 安装速度更快，得益于全局存储和硬链接机制，减少了文件复制。
  - 支持**增量安装**，只更新有变化的依赖。
  - 占用磁盘空间更小（通常比 npm 节省 2-3 倍空间）。

### 3. **node_modules 结构**

- npm：
  - 扁平化结构可能导致“幽灵依赖”问题（项目意外使用未在 package.json 中声明的依赖）。
  - 依赖解析可能更复杂，尤其在版本冲突时。
- pnpm：
  - 使用**符号链接**（symlinks）创建一个隔离的 node_modules 结构，模拟嵌套布局。
  - 严格遵守 package.json 的依赖声明，避免幽灵依赖。
  - 更清晰的依赖树，减少版本冲突问题。

### 4. **工作区支持（Monorepo）**

- npm：
  - 自 npm 7 起支持工作区（Workspaces），但功能相对基础，适合简单的 Monorepo 项目。
  - 对复杂 Monorepo 的支持不够完善。
- pnpm：
  - 原生支持工作区，专为 Monorepo 优化，提供强大的工作区管理功能（如 pnpm -r 运行命令）。
  - 更适合大型 Monorepo 项目（如前端框架或企业级应用）。

### 5. **兼容性和生态**

- npm：
  - 是 Node.js 官方默认包管理工具，与 npm 生态高度兼容。
  - 大多数工具和库都以 npm 为标准测试，社区支持广泛。
- pnpm：
  - 与 npm 高度兼容，可运行大多数 npm 脚本和命令。
  - 某些特殊场景（例如需要修改 node_modules 结构的工具）可能需要额外配置。
  - 社区规模较小，但增长迅速。

### 6. **命令和功能**

- npm：
  - 提供标准命令如 install、run、publish 等。
  - 功能全面，但一些高级功能需要依赖第三方插件。
- pnpm：
  - 命令与 npm 类似（如 pnpm install、pnpm add），但额外提供独特功能：
    - pnpm store：管理全局依赖存储。
    - pnpm outdated：检查过期依赖。
    - pnpm why：分析依赖来源。
  - 支持更细粒度的依赖管理，例如 --filter 用于 Monorepo 项目。

### 7. **其他特性**

- npm：
  - 支持 package-lock.json 锁定依赖版本，保证安装一致性。
  - 内置发布功能，适合直接发布到 npm 仓库。
- pnpm：
  - 使用 pnpm-lock.yaml 锁定依赖，格式更简洁。
  - 支持**快速补丁**（Fast Patch）功能，允许临时修改依赖而不更改源代码。
  - 提供 --strict-peer-dependencies 等选项，增强依赖校验。

### 8. **适用场景**

- npm：
  - 适合小型项目或对生态兼容性要求高的场景。
  - 适合初学者或对性能要求不高的项目。
  - 如果团队习惯 npm 工作流，迁移成本低。
- pnpm：
  - 适合大型项目、Monorepo 或磁盘空间敏感的场景。
  - 适合追求高性能和高效依赖管理的开发团队。
  - 适合需要严格依赖隔离的场景（如避免幽灵依赖）。

### 总结

| 特性              | npm              | pnpm                     |
| ----------------- | ---------------- | ------------------------ |
| **存储方式**      | 扁平化，重复存储 | 全局存储 + 硬链接        |
| **磁盘空间**      | 占用较多         | 占用较少（2-3 倍节省）   |
| **安装速度**      | 较慢             | 更快                     |
| **幽灵依赖**      | 可能存在         | 严格避免                 |
| **Monorepo 支持** | 基础支持         | 强大支持                 |
| **生态兼容性**    | 高度兼容         | 高度兼容，少数场景需配置 |
| **学习曲线**      | 简单             | 稍陡，但命令类似         |

**选择建议**：

- 如果你在乎**性能**、**磁盘空间**或需要管理 **Monorepo**，推荐使用 **pnpm**。
- 如果你需要**最大兼容性**、简单工作流或团队熟悉 npm，选择 **npm**。
